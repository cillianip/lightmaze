<!DOCTYPE html>
<html>
<head>
    <title>Light Maze Demo</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        #demo-info {
            text-align: center;
            padding: 1rem;
            color: #00ffff;
            font-family: 'Orbitron', monospace;
        }
        #demo-canvas {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="demo-info">
            <h2>Light Maze - Ray Casting Demo</h2>
            <p>Click to rotate mirror â€¢ Drag to move mirror</p>
        </div>
        <div id="canvas-container">
            <canvas id="demo-canvas" width="800" height="600"></canvas>
        </div>
    </div>
    
    <script type="module">
        import { Vector2, RayCaster, Renderer } from './js/engine.js';
        import { LightSource, Mirror, Crystal, Wall } from './js/entities.js';
        
        const canvas = document.getElementById('demo-canvas');
        const renderer = new Renderer(canvas);
        const rayCaster = new RayCaster();
        
        // Create entities
        const lightSource = new LightSource(2, 7, 0); // pointing right
        const mirror1 = new Mirror(10, 7, Math.PI / 4); // 45 degrees
        const crystal1 = new Crystal(17, 7);
        const crystal2 = new Crystal(10, 2);
        
        // Create walls
        const walls = [
            new Wall(0, 0, 20, 1),
            new Wall(0, 14, 20, 1), 
            new Wall(0, 0, 1, 15),
            new Wall(19, 0, 1, 15),
            // Add some interior walls
            new Wall(5, 5, 1, 5),
            new Wall(15, 8, 1, 4)
        ];
        
        const entities = [lightSource, mirror1, crystal1, crystal2, ...walls];
        let isDragging = false;
        let draggedMirror = null;
        
        function gameLoop() {
            // Clear crystals
            crystal1.deactivate();
            crystal2.deactivate();
            
            // Cast rays
            const rays = rayCaster.cast(lightSource, entities);
            
            // Render
            renderer.clear();
            renderer.drawGrid(40);
            
            // Draw entities
            entities.forEach(entity => renderer.drawEntity(entity));
            
            // Draw rays
            renderer.drawRays(rays);
            
            requestAnimationFrame(gameLoop);
        }
        
        // Mouse interactions
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicking on mirror
            const dist = Math.sqrt(Math.pow(x - mirror1.x, 2) + Math.pow(y - mirror1.y, 2));
            if (dist < 30) {
                if (e.button === 0) { // Left click - drag
                    isDragging = true;
                    draggedMirror = mirror1;
                    mirror1.startDrag(x, y);
                }
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging && draggedMirror) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                draggedMirror.updateDrag(x, y);
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            if (draggedMirror) {
                draggedMirror.endDrag();
            }
            isDragging = false;
            draggedMirror = null;
        });
        
        canvas.addEventListener('click', (e) => {
            if (!isDragging) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if clicking on mirror
                const dist = Math.sqrt(Math.pow(x - mirror1.x, 2) + Math.pow(y - mirror1.y, 2));
                if (dist < 30) {
                    mirror1.rotate();
                }
            }
        });
        
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // Start game loop
        gameLoop();
    </script>
</body>
</html>